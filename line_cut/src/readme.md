# 法帖行切り出し

## 全体の流れ

基本的には番号順にプログラムを動かせばOKです。流れとしては

1. collection.jsonに基づいてマニフェストをダウンロード
2. マニフェストに基づいて画像をダウンロード
3. Google Cloud Visionに文字の相対サイズを問合せ、結果をoutput/{法帖名}に保存
4. 3の結果に基づいて、各法帖に対して行探知を行い、結果をoutput/{法帖名}/line_placeに保存
5. 保存されたline_placeが適切かどうかを、画像を見ながら修正する（ちょっと大変そう）
6. line_placeに基づいてキュレーションリストを作成する

注意点としては、
1について→手動でマニフェストを格納してもOK
2について→UPARLの資料はなぜかImage APIのURLじゃないのでThumbnailからやっている、そのためプログラムを動かすときにUparlかどうかでYes/Noを選択する必要がある
3について→プログラムが不安定で修正し切れていないため、不具合があるかも
4について→あらかじめ背景色塗り潰しのためにboundaryを設定するので、3_1のboundaryCheckerでいくつか閾値を試して欲しい
5について→作品とページを指定して1ページずつやっていくので、かなり大変になるかもしれないです...
6について→ほぼやるだけ

## 1の詳細

input/collectionから、jsonファイル名を指定するとそれを読み込み、collectionタイプに記述されているマニフェストファイルをダウンロードする
ダウンロードされたマニフェストはinput/manifestに格納される

## 2の詳細

マニフェストファイルから、記述されている法帖の@id, identifier, sequenceを取り出す
identifierや@idは6でキュレーションリストを作成するときに使う
注意点で書いた通り、UPARLではsequences/canvas/images/resource/@idにImage API対応のURLがないので、現状ではThumbnailタイプからImage API準拠のURLを入手する。
画像は1000,のサイズでダウンロードし、input/images/{法帖名}にページごとにフォルダを作って格納する。詳細は以下の通り。
```
-- images --hojo_info.txt
           -p1
           -p2
           ...
```
hojo_info.txtにはマニフェストのURL、識別子、元画像の幅、高さの情報が記述されており、各ページのフォルダにはリサイズされた画像と、画像のCanvasIDを記したcanvas_id.txtが格納される。

## 3の詳細

Google Cloud Visionに問い合わせて、input/images内にある各法帖に対して、各ページにある文字の相対サイズを計算する
GCVからの応答はjson形式なので、そこから該当する情報を取って相対サイズを抽出する
各ページにある文字の相対サイズは/output/{法帖名}/rintervals.jsonに保存される。
rintervals.jsonの形式は以下の通り
```
{"p1":0.02, "p2":0.01,...}
```
なお、すでにrintervalsがあれば問い合わせはされない。

## 4の詳細


## 5の詳細


## 6の詳細
